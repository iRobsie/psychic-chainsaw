<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Repo Browser — Dark by default</title>
  <meta name="referrer" content="no-referrer" />
  <style>
    /* Fluid base size */
    html { font-size: clamp(13px, 1.25vw, 18px); box-sizing: border-box; }
    *,*::before,*::after{box-sizing:inherit}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      background: var(--bg);
      color: var(--text);
      display:flex; align-items:flex-start; justify-content:center;
      padding: clamp(12px, 2.2vw, 32px);
      transition: background .18s, color .18s;
    }

    /* Theme variables (dark default) */
    :root{
      --bg: #0b0f15;
      --panel: linear-gradient(180deg, #0f1720, #0b1117);
      --muted: #9aa4b2;
      --accent: #58a6ff;
      --accent-2: #7c3aed;
      --card-bg: rgba(255,255,255,0.02);
      --border: rgba(255,255,255,0.06);
      --text: #e6eef8;
      --glass: rgba(255,255,255,0.02);
      --radius: 12px;
      --shadow: 0 8px 30px rgba(2,6,23,0.6);
      --btn-bg: rgba(255,255,255,0.03);
      --btn-border: rgba(255,255,255,0.04);
      --maxw: 1200px;
    }

    /* Light theme overrides */
    :root[data-theme="light"]{
      --bg: linear-gradient(180deg,#f7f9fc,#ffffff);
      --panel: linear-gradient(180deg,#ffffff,#fbfdff);
      --muted: #6b7280;
      --accent: #0f62fe;
      --accent-2: #7c3aed;
      --card-bg: rgba(8,12,20,0.02);
      --border: rgba(16,24,40,0.06);
      --text: #0b1220;
      --glass: rgba(0,0,0,0.03);
      --shadow: 0 10px 30px rgba(16,24,40,0.06);
      --btn-bg: #fff;
      --btn-border: rgba(16,24,40,0.06);
    }

    /* Shell */
    .shell{
      width: min(98vw, var(--maxw));
      border-radius: calc(var(--radius) + 4px);
      background: var(--panel);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      overflow: hidden;
    }

    header{
      display:flex;align-items:center;justify-content:space-between;padding:1rem 1.1rem;border-bottom:1px solid rgba(255,255,255,0.02);
      gap:clamp(8px,1.2vw,20px);
    }
    .brand{display:flex;gap:0.75rem;align-items:center}
    .logo{width:3rem;height:3rem;border-radius:10px;display:grid;place-items:center;color:white;font-weight:700;
      background: linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:0 6px 18px rgba(8,12,20,0.25)}
    .title{font-weight:700;font-size:1.05rem}
    .sub{font-size:0.85rem;color:var(--muted)}

    /* Controls */
    .controls{display:flex;gap:0.6rem;align-items:center;flex-wrap:wrap}
    .search{display:flex;align-items:center;gap:0.6rem;padding:0.5rem 0.75rem;border-radius:999px;background:var(--glass);border:1px solid var(--btn-border);min-width:12rem}
    .search input{background:transparent;border:0;outline:0;color:var(--text);width:18rem;font-size:0.95rem}
    .btn{padding:0.45rem 0.65rem;border-radius:10px;border:1px solid var(--btn-border);background:var(--btn-bg);color:var(--text);cursor:pointer;font-size:0.95rem}
    .pill{padding:0.35rem 0.6rem;border-radius:999px;border:1px solid var(--btn-border);background:transparent;color:var(--muted);font-size:0.9rem}

    /* Layout */
    .content{display:grid;grid-template-columns: 1fr 22.5rem;gap:clamp(12px,2vw,20px);padding:clamp(12px,2vw,18px)}
    @media (max-width:1100px){ .content{grid-template-columns:1fr} .preview{order:2} }

    .explorer{padding:0.9rem;border-radius:calc(var(--radius));background:var(--card-bg);border:1px solid rgba(255,255,255,0.02)}
    .crumbs{font-size:0.95rem;color:var(--muted);margin-bottom:0.6rem;word-break:break-all}

    .controls-inline{display:flex;gap:0.6rem;align-items:center;margin-bottom:0.6rem}

    .list{border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.02);background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent)}
    .list .head{display:grid;grid-template-columns:38px 1fr 9rem 9.5rem;padding:0.7rem 0.9rem;color:var(--muted);font-size:0.95rem;border-bottom:1px solid rgba(255,255,255,0.02)}
    .rows{max-height:52vh;overflow:auto}
    .row{display:grid;grid-template-columns:38px 1fr 9rem 9.5rem;padding:0.7rem 0.9rem;border-top:1px solid rgba(255,255,255,0.02);align-items:center;gap:0.6rem}
    .row:hover{background:linear-gradient(90deg, rgba(88,166,255,0.03), transparent)}
    .name strong{font-size:0.98rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .ic{width:2rem;height:2rem;border-radius:8px;display:grid;place-items:center;background:rgba(88,166,255,0.04);color:var(--accent);font-weight:600}

    .preview{padding:0.9rem;border-radius:calc(var(--radius));background:var(--card-bg);border:1px solid rgba(255,255,255,0.02);display:flex;flex-direction:column;gap:0.6rem;min-height:40vh}
    .preview-body{flex:1;overflow:auto;border-radius:10px;padding:0.6rem;border:1px dashed rgba(255,255,255,0.02);background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .muted-sm{font-size:0.88rem;color:var(--muted)}

    /* Floating theme toggle — big, bottom-right */
    #themeToggle{
      position:fixed;right:clamp(12px,2.2vw,28px);bottom:clamp(12px,2.2vw,28px);
      width:clamp(52px,6.2vw,72px);height:clamp(52px,6.2vw,72px);border-radius:999px;
      display:grid;place-items:center;z-index:1200;border:0;cursor:pointer;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.05));
      box-shadow: 0 10px 30px rgba(2,6,23,0.45);
      color: var(--text); font-size:1.15rem;
      border: 1px solid rgba(255,255,255,0.06);
    }
    #themeToggle svg{width:56%;height:56%}
    #themeToggle:focus{outline:3px solid rgba(88,166,255,0.18);outline-offset:3px}

    .inline{color:var(--accent)}
    .spinner{width:1rem;height:1rem;border-radius:50%;border:2px solid rgba(255,255,255,0.06);border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="shell" id="app" data-owner="" data-repo="" data-branch="">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">RB</div>
        <div>
          <div class="title">Repo Browser</div>
          <div class="sub" id="repoSub">—</div>
        </div>
      </div>

      <div class="controls" role="region" aria-label="controls">
        <div class="search" title="Filter (press F)">
          <input id="q" placeholder="Filter (ext:css or text)" aria-label="search" />
          <div class="pill muted-sm" id="statsPill">—</div>
        </div>
        <button class="btn" id="upBtn" title="Up">Up</button>
        <button class="btn" id="rootBtn" title="Root">Root</button>
        <div class="pill" id="repoPill">—</div>
        <button class="btn" id="refreshBtn" title="Refresh">Refresh</button>
      </div>
    </header>

    <div class="content">
      <section class="explorer">
        <div class="crumbs" id="breadcrumbs">/</div>

        <div class="controls-inline">
          <div class="pill muted-sm" id="branchPill">branch: —</div>
          <div style="margin-left:auto;display:flex;gap:0.5rem">
            <select id="sort" class="pill" title="Sort">
              <option value="name">name</option><option value="type">type</option><option value="size">size</option>
            </select>
            <button class="btn" id="computeBtn">Compute sizes</button>
          </div>
        </div>

        <div class="list" id="listRoot">
          <div class="head"><div></div><div>Name</div><div>Size</div><div>Last modified</div></div>
          <div class="rows" id="rows"></div>
        </div>

        <div style="margin-top:0.8rem;display:flex;gap:0.6rem;align-items:center">
          <a id="apiLink" class="muted-sm inline" target="_blank" rel="noopener">API</a>
          <div class="muted-sm" style="margin-left:auto" id="limitNote">Unauthenticated ~60 req/hr</div>
        </div>
      </section>

      <aside class="preview">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div id="previewTitle" style="font-weight:700">Select a file or folder</div>
            <div class="muted-sm" id="previewSub">—</div>
          </div>
          <div id="previewActions"></div>
        </div>

        <div class="preview-body" id="previewBody"><div class="muted-sm">Select an item to view metadata and open it on the site.</div></div>
        <div class="muted-sm" id="metaFooter">—</div>
      </aside>
    </div>
  </div>

  <!-- Theme toggle — large and visible -->
  <button id="themeToggle" aria-label="Toggle color theme" title="Toggle theme (press T)">
    <svg id="iconSun" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden>
      <circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="1.4" />
      <path d="M12 2v1.8M12 20.2V22M4.22 4.22l1.27 1.27M18.51 18.51l1.27 1.27M2 12h1.8M20.2 12H22M4.22 19.78l1.27-1.27M18.51 5.49l1.27-1.27" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
    </svg>
    <svg id="iconMoon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden style="display:none">
      <path d="M21 12.79A9 9 0 0111.21 3 7 7 0 0021 12.79z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>

<script>
/* THEME: default dark; toggle to light, remember in localStorage */
(function themeInit(){
  const stored = localStorage.getItem('rb-theme');
  const initial = stored || 'dark';
  if(initial === 'light') document.documentElement.setAttribute('data-theme','light');
  const btn = document.getElementById('themeToggle');
  const iconSun = document.getElementById('iconSun');
  const iconMoon = document.getElementById('iconMoon');
  function updateIcons(){
    const isLight = document.documentElement.getAttribute('data-theme') === 'light';
    iconSun.style.display = isLight ? 'none' : 'block';
    iconMoon.style.display = isLight ? 'block' : 'none';
    btn.setAttribute('aria-pressed', String(isLight));
  }
  updateIcons();
  btn.addEventListener('click', () => {
    const currentIsLight = document.documentElement.getAttribute('data-theme') === 'light';
    if(currentIsLight){
      document.documentElement.removeAttribute('data-theme');
      localStorage.setItem('rb-theme','dark');
    } else {
      document.documentElement.setAttribute('data-theme','light');
      localStorage.setItem('rb-theme','light');
    }
    updateIcons();
  });
  window.addEventListener('keydown', (e) => { if(e.key.toLowerCase() === 't') { btn.click(); } });
})();

/* --- Repo browser (IndexedDB + SHA check) --- */
const $ = id => document.getElementById(id);
const qs = new URLSearchParams(location.search);
const appEl = document.getElementById('app');
const ownerFromApp = appEl.dataset.owner || '';
const repoFromApp = appEl.dataset.repo || '';
const branchFromApp = appEl.dataset.branch || '';

function fmtBytes(b){ if (b == null) return ''; if (b < 1024) return b + ' B'; if (b < 1024**2) return (b/1024).toFixed(1)+' KB'; if (b < 1024**3) return (b/1024**2).toFixed(1)+' MB'; return (b/1024**3).toFixed(2)+' GB'; }
function safe(s){ return String(s||'').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function extOf(name){ return (name.split('.').pop()||'').toLowerCase(); }
function isImageExt(e){ return ['png','jpg','jpeg','gif','webp','svg'].includes(e); }
function mkIcon(type,name){ if(type==='dir') return '<div class="ic">📁</div>'; const e=extOf(name); if(isImageExt(e)) return '<div class="ic">🖼</div>'; return '<div class="ic">📄</div>'; }

function apiContentsUrl(owner,repo,path,branch){ const p = path ? '/' + encodeURIComponent(path).replace(/%2F/g,'/') : ''; return `https://api.github.com/repos/${owner}/${repo}/contents${p}?ref=${encodeURIComponent(branch)}`; }
function apiCommitsLatestUrl(owner,repo,branch){ return `https://api.github.com/repos/${owner}/${repo}/commits?per_page=1&sha=${encodeURIComponent(branch)}`; }

/* Build the Pages URL for a file so clicking opens the github.io page (same tab) */
function buildPagesUrl(path){
  // if this is a user site (owner.github.io), path is served from origin/path
  const isUserSite = location.hostname.endsWith('github.io') && (state.repo === `${state.owner}.github.io`);
  const base = location.origin;
  const p = path.replace(/^\/+|\/+$/g,'');
  if(isUserSite) return `${base}/${encodeURI(p)}`;
  // otherwise pages for project sites are usually at origin/<repo>/<path>
  return `${base}/${encodeURIComponent(state.repo)}/${encodeURI(p)}`;
}

/* IndexedDB wrapper (small) */
const IDB_NAME = 'repo-browser-db';
const IDB_VERSION = 1;
const IDB_STORE = 'kv';
function openIdb(){ return new Promise((resolve,reject)=>{ const r=indexedDB.open(IDB_NAME,IDB_VERSION); r.onupgradeneeded=(e)=>{ const db=e.target.result; if(!db.objectStoreNames.contains(IDB_STORE)) db.createObjectStore(IDB_STORE,{keyPath:'k'}); }; r.onsuccess=()=>resolve(r.result); r.onerror=()=>reject(r.error); }); }
async function idbGet(k){ try{ const db=await openIdb(); return await new Promise((res,rej)=>{ const tx=db.transaction(IDB_STORE,'readonly'); const st=tx.objectStore(IDB_STORE); const r=st.get(k); r.onsuccess=()=>res(r.result ? r.result.v : undefined); r.onerror=()=>rej(r.error); }); }catch(e){return undefined;} }
async function idbPut(k,v){ try{ const db=await openIdb(); return await new Promise((res,rej)=>{ const tx=db.transaction(IDB_STORE,'readwrite'); const st=tx.objectStore(IDB_STORE); const r=st.put({k,v}); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }); }catch(e){return false;} }
async function idbDel(k){ try{ const db=await openIdb(); return await new Promise((res,rej)=>{ const tx=db.transaction(IDB_STORE,'readwrite'); const st=tx.objectStore(IDB_STORE); const r=st.delete(k); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }); }catch(e){return false;} }

/* State */
let state = { owner:'', repo:'', branch:'', path:'' };

/* UI helpers */
function setHeader(owner,repo,branch){ $('repoPill').textContent = `${owner}/${repo}`; $('repoSub').textContent = `${owner}/${repo}`; $('branchPill').textContent = `branch: ${branch}`; }
function setApiLink(path){ const url = apiContentsUrl(state.owner,state.repo,path || '',state.branch); $('apiLink').href = url; $('apiLink').textContent = url.replace('https://api.github.com/',''); }

/* Get latest branch SHA */
async function fetchLatestBranchSha(){ try{ const url = apiCommitsLatestUrl(state.owner,state.repo,state.branch); const res = await fetch(url, { headers: { 'Accept': 'application/vnd.github.v3+json' }}); if(!res.ok) return null; const arr = await res.json(); return arr && arr[0] && arr[0].sha ? arr[0].sha : null; }catch(e){ return null; } }

/* Fetch directory with cache / SHA check */
async function fetchDirWithCache(path){
  const repoKey = `${state.owner}:${state.repo}:${state.branch}`;
  const dirKey = `${repoKey}:dir:${path || ''}`;
  const metaKey = `${repoKey}:meta`;
  const cachedDir = await idbGet(dirKey);
  const cachedMeta = await idbGet(metaKey);
  let latestSha = null;
  try{ latestSha = await fetchLatestBranchSha(); }catch(e){ latestSha = null; }
  if(cachedDir && cachedMeta && cachedMeta.latestSha && latestSha && cachedMeta.latestSha === latestSha){
    return { items: cachedDir.items, fromCache: true, latestSha };
  }
  const url = apiContentsUrl(state.owner,state.repo,path || '',state.branch);
  const res = await fetch(url, { headers: { 'Accept': 'application/vnd.github.v3+json' }});
  if(!res.ok) throw new Error(`API ${res.status}: ${res.statusText}`);
  const data = await res.json();
  if(!Array.isArray(data)) throw new Error('Not a directory');
  data.sort((a,b)=>(a.type===b.type ? a.name.localeCompare(b.name,undefined,{numeric:true}) : a.type==='dir' ? -1 : 1));
  const normalized = data.map(x=>({ name:x.name, path:x.path, type:x.type, size:x.size||0, sha:x.sha, url:x.url, download_url:x.download_url }));
  await idbPut(dirKey, { items: normalized, fetchedAt: Date.now() });
  if(latestSha) await idbPut(metaKey, { latestSha, checkedAt: Date.now() });
  return { items: normalized, fromCache:false, latestSha };
}

/* Render rows */
function renderRows(items){
  const rows = $('rows');
  if(!items || items.length === 0){ rows.innerHTML = '<div class="row"><div style="grid-column:1/-1;color:var(--muted)">Empty</div></div>'; $('statsPill').textContent = '0 items'; return; }
  const sizeSum = items.reduce((s,i)=> s + (i.type==='file' ? (i.size||0) : 0), 0);
  $('statsPill').textContent = `${items.length} • ${fmtBytes(sizeSum)}`;
  rows.innerHTML = items.map(it => {
    const ico = mkIcon(it.type, it.name);
    const size = it.type==='dir' ? '' : fmtBytes(it.size);
    return `<div class="row" data-path="${safe(it.path)}" data-type="${it.type}">
      <div>${ico}</div>
      <div class="name"><strong title="${safe(it.name)}">${safe(it.name)}</strong><div class="muted-sm" style="margin-left:42px;margin-top:4px">${safe(it.path)}</div></div>
      <div class="muted-sm" data-size>${size}</div>
      <div class="muted-sm" data-updated></div>
    </div>`;
  }).join('');
  rows.querySelectorAll('.row').forEach(r=>{
    r.addEventListener('click',(ev)=>{
      const path = r.getAttribute('data-path'); const type = r.getAttribute('data-type');
      if(ev.detail === 2){
        if(type === 'dir') return navigate(path);
        // double-click file -> open within the github.io page (same tab)
        const url = buildPagesUrl(path);
        location.href = url;
        return;
      }
      // single-click: show metadata (no code preview)
      showMetadataPreview(path, type);
    });
    const p = r.getAttribute('data-path');
    (async ()=> {
      try{
        const url = `https://api.github.com/repos/${state.owner}/${state.repo}/commits?path=${encodeURIComponent(p)}&per_page=1&sha=${encodeURIComponent(state.branch)}`;
        const res = await fetch(url, { headers: { 'Accept': 'application/vnd.github.v3+json' }});
        if(!res.ok) return;
        const arr = await res.json();
        if(arr && arr[0] && arr[0].commit && arr[0].commit.committer){
          const d = new Date(arr[0].commit.committer.date);
          const upd = r.querySelector('[data-updated]'); if(upd) upd.textContent = d.toLocaleString();
        }
      }catch(e){}
    })();
  });
}

/* Metadata preview only — no code display */
async function showMetadataPreview(path,type){
  $('previewTitle').textContent = path.split('/').pop();
  $('previewSub').textContent = `${type} • ${path}`;
  $('previewActions').innerHTML = '';
  setApiLink(path);
  // actions: open on site, open github, copy path
  const actions = $('previewActions');
  actions.appendChild(createBtn('Open on site', ()=> { location.href = buildPagesUrl(path); }));
  actions.appendChild(createBtn('GitHub', ()=> { window.open(`https://github.com/${state.owner}/${state.repo}/${type === 'dir' ? 'tree' : 'blob'}/${state.branch}/${path}`,'_blank'); }));
  actions.appendChild(createBtn('Copy path', ()=> { navigator.clipboard?.writeText(path).then(()=>alert('copied')).catch(()=>alert('copy failed')); }));

  // preview body: for images we still show an image preview (useful), otherwise concise metadata only
  if(type === 'dir'){
    $('previewBody').innerHTML = `<div style="padding:0.6rem"><strong>Folder</strong><div class="muted-sm" style="margin-top:0.5rem">${safe(path)}</div></div>`;
  } else {
    if(isImageExt(extOf(path))){
      const url = buildPagesUrl(path);
      $('previewBody').innerHTML = `<img src="${url}" alt="${safe(path)}" style="max-width:100%;display:block;margin:auto;border-radius:8px"/>`;
    } else {
      $('previewBody').innerHTML = `<div style="padding:0.6rem"><div class="muted-sm">No in-page preview for file contents. Click "Open on site" to view it on the GitHub Pages site.</div></div>`;
    }
  }

  // commit metadata
  const commit = await fetchLastCommit(path);
  $('metaFooter').textContent = commit ? `${commit.author || 'unknown'} • ${new Date(commit.date).toLocaleString()} • ${commit.message}` : '—';
}

function createBtn(label,onClick){ const b=document.createElement('button'); b.className='btn'; b.textContent=label; b.addEventListener('click', onClick); return b; }

async function fetchLastCommit(path){
  try{
    const url = `https://api.github.com/repos/${state.owner}/${state.repo}/commits?path=${encodeURIComponent(path)}&per_page=1&sha=${encodeURIComponent(state.branch)}`;
    const res = await fetch(url, { headers: { 'Accept': 'application/vnd.github.v3+json' }});
    if(!res.ok) return null;
    const arr = await res.json();
    if(arr && arr[0]) return { sha: arr[0].sha, date: arr[0].commit.committer.date, message: arr[0].commit.message, author: arr[0].commit.author ? arr[0].commit.author.name : (arr[0].author ? arr[0].author.login : '') };
    return null;
  }catch(e){ return null; }
}

/* compute sizes (same behavior) */
async function computeFolderSize(path){
  if(!confirm('Compute sizes recursively? This may use many API calls.')) throw new Error('cancel');
  let total = 0;
  async function walk(p){
    const url = apiContentsUrl(state.owner,state.repo,p || '',state.branch);
    const res = await fetch(url, { headers: { 'Accept': 'application/vnd.github.v3+json' }});
    if(!res.ok) throw new Error('API error');
    const arr = await res.json();
    if(!Array.isArray(arr)) return;
    for(const e of arr){ if(e.type==='file') total += e.size || 0; else if(e.type==='dir') await walk(e.path); }
  }
  await walk(path || '');
  const sizeKey = `${state.owner}:${state.repo}:${state.branch}:size:${path || ''}`;
  await idbPut(sizeKey, { size: total, computedAt: Date.now() });
  return total;
}

/* navigate & render pipeline */
async function navigate(path){
  state.path = (path || '').replace(/^\/+|\/+$/g,'');
  $('breadcrumbs').textContent = '/' + (state.path || '');
  setApiLink(state.path);
  $('upBtn').disabled = !state.path; $('rootBtn').disabled = !state.path;
  try{
    const res = await fetchDirWithCache(state.path);
    if(res.latestSha){ const repoKey = `${state.owner}:${state.repo}:${state.branch}`; await idbPut(`${repoKey}:meta`, { latestSha: res.latestSha, checkedAt: Date.now() }); }
    renderCurrent(res.items);
  }catch(err){
    $('rows').innerHTML = `<div class="row"><div style="grid-column:1/-1;color:#e06a6a;padding:12px">Error: ${err.message}</div></div>`;
  }
}
function renderCurrent(items){
  const q = ($('q').value || '').trim().toLowerCase();
  const filtered = (items || []).filter(it => {
    if(!q) return true;
    if(q.startsWith('ext:')) return extOf(it.name) === q.slice(4);
    return it.name.toLowerCase().includes(q) || it.path.toLowerCase().includes(q);
  });
  const sorter = $('sort').value;
  filtered.sort((a,b)=>{
    if(sorter==='name') return a.name.localeCompare(b.name,undefined,{numeric:true});
    if(sorter==='type'){ if(a.type===b.type) return a.name.localeCompare(b.name); return a.type==='dir' ? -1 : 1; }
    if(sorter==='size') return (b.size||0) - (a.size||0);
    return 0;
  });
  renderRows(filtered);
}

/* Initialization */
(async function init(){
  let owner = qs.get('owner') || ownerFromApp;
  let repo = qs.get('repo') || repoFromApp;
  let branch = qs.get('branch') || branchFromApp;
  const host = location.hostname;
  const path = location.pathname.replace(/^\/+|\/+$/g,'');
  if(!owner || !repo){
    if(host.endsWith('github.io')){
      owner = owner || host.split('.')[0];
      const segs = path.split('/').filter(Boolean);
      repo = repo || (segs[0] || `${owner}.github.io`);
    }
  }
  if(!owner || !repo){
    $('rows').innerHTML = `<div class="row"><div style="grid-column:1/-1;color:var(--muted);padding:12px">Add ?owner=YOU&repo=REPO to URL</div></div>`;
    return;
  }
  state.owner = owner; state.repo = repo; state.branch = branch || '';
  setHeader(state.owner,state.repo,state.branch || 'detecting...');
  $('limitNote').textContent = 'Unauthenticated ~60 req/hr';

  async function detectBranch(pref){
    const candidates = []; if(pref) candidates.push(pref); candidates.push('main','master');
    for(const br of candidates){ try{ const r = await fetch(apiContentsUrl(state.owner,state.repo,'',br), { headers:{ 'Accept':'application/vnd.github.v3+json' }}); if(r.ok) return br; }catch(e){} }
    try{ const r = await fetch(`https://api.github.com/repos/${state.owner}/${state.repo}`, { headers:{ 'Accept':'application/vnd.github.v3+json' }}); if(r.ok){ const j = await r.json(); return j.default_branch || ''; } }catch(e){}
    return '';
  }

  try{
    const br = await detectBranch(state.branch);
    if(!br){ $('rows').innerHTML = `<div class="row"><div style="grid-column:1/-1;color:var(--muted);padding:12px">Could not detect branch; add ?branch=main</div></div>`; return; }
    state.branch = br;
    setHeader(state.owner,state.repo,state.branch);
    await navigate('');
  }catch(e){
    $('rows').innerHTML = `<div class="row"><div style="grid-column:1/-1;color:#e06a6a;padding:12px">Init error: ${e.message}</div></div>`;
  }

  $('q').addEventListener('input', () => {
    const repoKey = `${state.owner}:${state.repo}:${state.branch}`;
    const dirKey = `${repoKey}:dir:${state.path || ''}`;
    idbGet(dirKey).then(cached => renderCurrent(cached ? cached.items : []));
  });
  $('sort').addEventListener('change', () => {
    const repoKey = `${state.owner}:${state.repo}:${state.branch}`;
    const dirKey = `${repoKey}:dir:${state.path || ''}`;
    idbGet(dirKey).then(cached => renderCurrent(cached ? cached.items : []));
  });
  $('refreshBtn').addEventListener('click', async ()=> {
    const repoKey = `${state.owner}:${state.repo}:${state.branch}`;
    const dirKey = `${repoKey}:dir:${state.path || ''}`;
    await idbDel(dirKey);
    await idbDel(`${repoKey}:meta`);
    await navigate(state.path);
  });
  $('upBtn').addEventListener('click', ()=> { if(!state.path) return; const parts = state.path.split('/').filter(Boolean); parts.pop(); navigate(parts.join('/')); });
  $('rootBtn').addEventListener('click', ()=> navigate(''));
  $('computeBtn').addEventListener('click', async ()=> {
    try{ $('computeBtn').disabled = true; $('computeBtn').textContent = 'Computing…'; const size = await computeFolderSize(state.path || ''); alert('Folder size: ' + fmtBytes(size)); const repoKey = `${state.owner}:${state.repo}:${state.branch}`; const dirKey = `${repoKey}:dir:${state.path || ''}`; const cached = await idbGet(dirKey); renderCurrent(cached ? cached.items : []); }catch(e){} finally{ $('computeBtn').disabled=false; $('computeBtn').textContent='Compute sizes'; }
  });

  window.addEventListener('keydown', (e) => { if(e.key === 'f' && document.activeElement.tagName !== 'INPUT'){ e.preventDefault(); $('q').focus(); } if(e.key === 'Escape'){ $('q').value=''; const repoKey = `${state.owner}:${state.repo}:${state.branch}`; const dirKey = `${repoKey}:dir:${state.path || ''}`; idbGet(dirKey).then(c=> renderCurrent(c ? c.items : [])); } });
})();
</script>
</body>
</html>
